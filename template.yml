AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Trades Management

Parameters:
  Environment:
    Type: AWS::SSM::Parameter::Value<String>
    Default: SantiveEnvironment
  PrivateSubnets:
    Type: AWS::SSM::Parameter::Value<List<String>>
    Default: PrivateSubnets
  PrivateSecurityGroups:
    Type: AWS::SSM::Parameter::Value<List<String>>
    Default: PrivateSecurityGroups

Mappings:
  Environments:
    development:
      LogLevel: DEBUG
      DatabaseSecret: "parameters:///trades-management/database_url"
    production:
      LogLevel: ERROR
      DatabaseSecret: "parameters:///trades-management/database_url"

Globals:
  Function:
    Runtime: python3.8
    Timeout: 30
    MemorySize: 256
    Layers:
      - Ref: TradesManagementDepLayer
    VpcConfig:
      SecurityGroupIds:
        Ref: PrivateSecurityGroups
      SubnetIds:
        Ref: PrivateSubnets
    Environment:
      Variables:
        ENVIRONMENT:
          Ref: Environment
        LOG_LEVEL:
          Fn::FindInMap:
            - Environments
            - Ref: Environment
            - LogLevel
        DATABASE_URL:
          Fn::FindInMap:
            - Environments
            - Ref: Environment
            - DatabaseSecret
        SENTRY_DSN: "https://e186ded0d7c64d029628fad2a9c92218@o1155645.ingest.sentry.io/6236195"

Resources:
  TradesManagementDepLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: sam-trades-management-dependencies
      Description: Python dependencies
      ContentUri: .aws-sam/dependencies
      LicenseInfo: "MIT"
      CompatibleRuntimes:
        - python3.8

  # API Gateway
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: trades-management-api
      StageName: v1
      DefinitionBody:
        Fn::Transform:
          Name: "AWS::Include"
          Parameters:
            Location: "./swagger.yml"

  UsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    DependsOn: ApiGatewayv1Stage
    Properties:
      ApiStages:
        - ApiId:
            Ref: ApiGateway
          Stage:
            Fn::Sub: v1
      Description: Unlimited usage plan for trades-management
      UsagePlanName: TradesManagementApi_Unlimited

  # Lambda

  Migrate:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 90
      FunctionName: trades-management-migrations
      CodeUri: migrations
      Handler: serpens.migrations.migrate_handler
      Policies:
        - AWSLambda_FullAccess
        - AmazonSSMFullAccess

  CreateBroker:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: trades-management-create-broker
      CodeUri: trades_management
      Handler: handlers.create_broker.handle
      Policies:
        - AWSLambda_FullAccess
        - AmazonSSMReadOnlyAccess
        - AmazonRDSFullAccess
      Events:
        PostBroker:
          Type: Api
          Properties:
            Path: /brokers
            Method: post
            RestApiId:
              Ref: ApiGateway

  UpdateBroker:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: trades-management-update-broker
      CodeUri: trades_management
      Handler: handlers.update_broker.handle
      Policies:
        - AWSLambda_FullAccess
        - AmazonSSMReadonlyAccess
        - AmazonRDSFullAccess
      Events:
        PutBroker:
          Type: Api
          Properties:
            Path: /brokers
            Mthod: put
            RestApiId:
              Ref: ApiGateway
